#!/usr/bin/env bash
set -u

# ì„¤ì • íŒŒì¼ ê²½ë¡œ
readonly LOG_FILE=".sisyphus/debug/PostToolUse.log"
readonly ERROR_TEMP=".sisyphus/debug/last_error.tmp"
readonly INFRA_KNOWLEDGE=".sisyphus/knowledge-base/infra-fixes.jsonl"
readonly LEARNING_KNOWLEDGE=".sisyphus/knowledge-base/learning-fixes.jsonl"

mkdir -p .sisyphus/debug .sisyphus/knowledge-base .sisyphus/evidence .sisyphus/logs 2>/dev/null

# FD 3ë¥¼ ë¡œê·¸ìš©ìœ¼ë¡œ ì‚¬ìš©
exec 3>>"$LOG_FILE"

echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”" >&3
echo "PostToolUse: $(date '+%Y-%m-%d %H:%M:%S.%3N')" >&3
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”" >&3

# 1. ìž…ë ¥ ë°ì´í„° ì½ê¸°
# ìž…ë ¥ì„ ì½ë˜, 2ì´ˆ ì´ìƒ ê±¸ë¦¬ë©´ ê°•ì œ ì¢…ë£Œ
input=$(timeout 2s cat)
if [ -z "$input" ] || [ "$input" = "{}" ]; then
    echo "âš  Empty input" >&3
    printf '{"cancel": false, "errorMessage":" "}'
    exit 0
fi
echo "âœ“ stdin read (${#input} bytes)" >&3

# 2. í•„ìˆ˜ ë°ì´í„° íŒŒì‹± (ê³µì‹ JSON ìŠ¤íŽ™ .postToolUse ê³„ì¸µ ë°˜ì˜)
echo "[2/6] Parsing..." >&3
TOOL=$(echo "$input" | jq -r '.postToolUse.toolName // empty')
RESULT=$(echo "$input" | jq -r '.postToolUse.result // empty')
# ì„±ê³µ ì—¬ë¶€ (boolean) ë° ì¢…ë£Œ ì½”ë“œ
SUCCESS=$(echo "$input" | jq -r '.postToolUse.success // true')
EXIT_CODE=$(echo "$input" | jq -r '.postToolUse.exitCode // 0')
DURATION=$(echo "$input" | jq -r '.postToolUse.executionTimeMs // 0' 2>/dev/null || echo "0")

# FILE_PATHë¥¼ ìƒë‹¨ì—ì„œ ê³µí†µ ì¶”ì¶œ (ì—†ì„ ê²½ìš° ë¹ˆ ë¬¸ìžì—´ë¡œ ì´ˆê¸°í™”í•˜ì—¬ set -u íšŒí”¼)
FILE_PATH=$(echo "$input" | jq -r '.postToolUse.parameters.path // .postToolUse.parameters.relative_path // ""')

echo "âœ“ TOOL=$TOOL DURATION=${DURATION}ms" >&3
echo "[TOOL] $TOOL (Success: $SUCCESS, Exit: $EXIT_CODE)" >&3

# 3. ì˜¤ë¥˜ ë°œìƒ ë° í•´ê²° ê°ì§€ ë¡œì§ (Minerva í•µì‹¬)
echo "[3/6] Knowledge Capturing..." >&3
case "$TOOL" in
    "execute_command")
        if [ "$SUCCESS" = "false" ] || echo "$RESULT" | grep -Ei "error|fail|exception|could not find" >/dev/null; then
            echo "âš  Failure detected. Advising MCP Diagnosis..." >&3
            # [NEW] ì—ëŸ¬ ë°œìƒ ì‹œ jetbrains-mcp get_diagnostics í˜¸ì¶œì„ ê¶Œê³ í•˜ëŠ” í”Œëž˜ê·¸ íŒŒì¼ ìƒì„±
            touch ".sisyphus/debug/NEED_MCP_DIAGNOSTIC"

            COMMAND=$(echo "$input" | jq -r '.postToolUse.parameters.command // "unknown"')
            jq -n --arg cmd "$COMMAND" --arg out "$RESULT" \
                '{command: $cmd, error_output: $out, timestamp: (now|strflocaltime("%Y-%m-%d %H:%M:%S"))}' > "$ERROR_TEMP"

        # ì„±ê³µ ê°ì§€: ì´ì „ì— ì—ëŸ¬ê°€ ì €ìž¥ë˜ì–´ ìžˆì—ˆëŠ”ë° ì§€ê¸ˆ ì„±ê³µí–ˆë‹¤ë©´?
        elif [[ -f "$ERROR_TEMP" ]]; then
            echo "â­ SUCCESS after failure! Extracting knowledge..." >&3
            PREV_ERROR=$(cat "$ERROR_TEMP")
            PREV_CMD=$(echo "$PREV_ERROR" | jq -r '.command')

            # ì¸í”„ë¼ vs í•™ìŠµ ë¶„ë¥˜
            TARGET_KB="$LEARNING_KNOWLEDGE"
            [[ "$PREV_CMD" =~ docker|gradlew?|npm|apt|pip|setup|oracle ]] && TARGET_KB="$INFRA_KNOWLEDGE"

            # ì§€ì‹ ë² ì´ìŠ¤ ê¸°ë¡
            jq -n \
               --argjson prev "$PREV_ERROR" \
               --arg now_cmd "$(echo "$input" | jq -r '.postToolUse.parameters.command')" \
               '{timestamp: (now|strflocaltime("%Y-%m-%d %H:%M:%S")), issue: $prev.error_output[:250], fail_cmd: $prev.command, fix_cmd: $now_cmd}' >> "$TARGET_KB"

            rm "$ERROR_TEMP"
            rm -f ".sisyphus/debug/NEED_MCP_DIAGNOSTIC"
            echo "âœ“ Knowledge captured in $(basename "$TARGET_KB")" >&3
        fi
        ;;

"write_to_file"|"apply_diff")
        if [[ -f "$ERROR_TEMP" && -n "$FILE_PATH" ]]; then
            echo "ðŸ“ File modification detected after error in $FILE_PATH" >&3
            # ì¶”ì¶œëœ ê²½ë¡œë¥¼ ì—ëŸ¬ ë¡œê·¸(ERROR_TEMP)ì— fix_file í•­ëª©ìœ¼ë¡œ ì¶”ê°€í•©ë‹ˆë‹¤.
            updated_error=$(jq --arg path "$FILE_PATH" '. + {fix_file: $path}' "$ERROR_TEMP")
            echo "$updated_error" > "$ERROR_TEMP"
        fi
        ;;
esac

# 4. ì„±ëŠ¥ ì²´í¬ (ê¸°ì¡´ ìœ ì§€)
echo "[4/6] Performance check..." >&3
if [ "$DURATION" -gt 3000 ]; then
    TS=$(date +%Y%m%d_%H%M%S)
    echo "âš  SLOW: ${DURATION}ms" >&3
    echo "[$TS] SLOW: $TOOL took ${DURATION}ms" >> .sisyphus/logs/performance.log
else
    echo "âœ“ Normal" >&3
fi

# 5. í…ŒìŠ¤íŠ¸ ë° ë¸Œë¼ìš°ì € ì²´í¬ (ê³µì‹ ê²½ë¡œ ë°˜ì˜ ìˆ˜ì •)
echo "[5/6] Content check..." >&3
# í…ŒìŠ¤íŠ¸ ë¦¬í¬íŠ¸ ì €ìž¥
if [ "$TOOL" = "execute_command" ] && echo "$RESULT" | grep -qiE "test|passed|failed" 2>/dev/null; then
    TS=$(date +%Y%m%d_%H%M%S)
    echo "âœ“ Test detected" >&3
    printf "%s" "$RESULT" > ".sisyphus/evidence/test_${TS}.log"
fi

# [NEW] 5.5 CRCT Sync (íŒŒì¼ ìˆ˜ì • ì‹œ progress.md ê°±ì‹  ê¶Œê³ )
if [[ "$TOOL" == "write_to_file" && ! "$FILE_PATH" =~ ^\.sisyphus/ ]]; then
    echo "âœ“ Source change detected. Syncing with cline_docs..." >&3
fi

# ë¸Œë¼ìš°ì € URL ë¡œê·¸ (ê³µì‹ ê²½ë¡œ .postToolUse.parameters.url)
if [ "$TOOL" = "browser_action" ] || [ "$TOOL" = "visit_page" ]; then
    URL=$(echo "$input" | jq -r '.postToolUse.parameters.url // empty')
    if [ -n "$URL" ]; then
        echo "âœ“ URL: $URL" >&3
        TS=$(date -Iseconds)
        jq -n --arg ts "$TS" --arg url "$URL" '{timestamp: $ts, url: $url}' >> .sisyphus/evidence/urls.json
    fi
fi

# 6. ìµœì¢… ì‘ë‹µ ì „ì†¡
echo "[6/6] Sending response..." >&3
printf '{"cancel": false, "errorMessage":" "}'
echo "âœ“ Response sent to Cline" >&3

exit 0
#!/usr/bin/env bash
set -u

readonly LOG_FILE=".sisyphus/debug/PreToolUse.log"
readonly STATE_FILE=".sisyphus/learning_state.json"
mkdir -p .sisyphus/debug 2>/dev/null

# FD 3ë¥¼ ë¡œê·¸ìš©ìœ¼ë¡œ ì‚¬ìš©
exec 3>>"$LOG_FILE"

# [1] ìž…ë ¥ ì½ê¸° (ê¸°ì¡´ ì•ˆì • ë¡œì§ ìœ ì§€)
input=$(timeout 2s cat)
[ -z "$input" ] || [ "$input" = "{}" ] && { printf '{"cancel": false, "errorMessage":" "}'; exit 0; }
echo "âœ“ stdin read (${#input} bytes)" >&3

TOOL=$(echo "$input" | jq -r '.preToolUse.toolName // empty')
FILE_PATH=$(echo "$input" | jq -r '.preToolUse.parameters.path // empty')
STATUS=$(jq -r '.status // "idle"' "$STATE_FILE" 2>/dev/null || echo "idle")

# [2] ì½”ë“œ ìž‘ì„± ë„êµ¬ ì°¨ë‹¨ (Exception: .sisyphus/ & jetbrains-mcp is ALWAYS allowed)
#case "$TOOL" in
#    write_to_file|apply_diff|replace_in_file)
#        if [[ ! "$FILE_PATH" =~ ^\.sisyphus/ ]]; then
#            printf ".preToolUse.parameters"
#            # ðŸš« ì¼„íŠ¸ ë²¡ ê°€ë“œë ˆì¼ ìœ ì§€
#            jq -n --arg msg "âš ï¸ Minerva v3.1: AI ì§ì ‘ ìˆ˜ì • ì œí•œ\n\nì§ì ‘ íƒ€ì´í•‘í•˜ì—¬ Small Stepì„ ì‹¤ì²œí•˜ì„¸ìš”.\nìˆ˜ì • ì „ jetbrains-mcpë¡œ ì˜ì¡´ì„±ì„ ë¨¼ì € í™•ì¸í–ˆë‚˜ìš”?" \
#                  '{cancel: true, errorMessage: $msg}'
#            exit 0
#        fi
#        ;;
#esac

# [NEW] MCP ë„êµ¬ ì‚¬ìš© ì‹œ ë¡œê·¸ ê¸°ë¡ (ì„ íƒ ì‚¬í•­)
if [[ "$TOOL" =~ ^jetbrains-mcp ]]; then
    echo "ðŸ” Symbol Scanning: $TOOL" >&3
fi

printf '{"cancel": false, "errorMessage":" "}'
exit 0
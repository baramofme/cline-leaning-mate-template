#!/usr/bin/env bash
set -u
readonly STATE_FILE=".sisyphus/learning_state.json"
readonly INFRA_FILE=".sisyphus/infra_status.json"
readonly PLAN_DIR=".sisyphus/plans"
exec 3>>".sisyphus/debug/UserPromptSubmit.log"

input=$(timeout 2s cat)
[ -z "$input" ] && { printf '{"cancel": false, "errorMessage":" "}'; exit 0; }

# [1] ìƒíƒœ ë¡œë“œ ë° ë¶„ì„
# ìƒíƒœ íŒŒì¼ì´ ì—†ê±°ë‚˜ statusê°€ 'learning'ì´ ì•„ë‹ˆë©´ ì»¨í…ìŠ¤íŠ¸ ì£¼ì… ìƒëµ
if [ ! -f "$STATE_FILE" ]; then
    printf '{"cancel": false, "errorMessage":" "}'
    exit 0
fi

STATUS=$(jq -r '.status // "idle"' "$STATE_FILE" 2>/dev/null)

# [Guard] learning ìƒíƒœê°€ ì•„ë‹ ë•ŒëŠ” ê°œì…í•˜ì§€ ì•ŠìŒ
if [ "$STATUS" != "learning" ]; then
    echo "âœ“ Status is $STATUS (not learning). Skipping context injection." >&3
    echo '{"cancel": false, "contextModification": " "}'
    exit 0
fi

# [2] Learning ëª¨ë“œ ì „ìš© ë°ì´í„° ë¡œë“œ
STEP=$(jq -r '.progress.currentStep // 1' "$STATE_FILE" 2>/dev/null)
TASK=$(jq -r '.progress.currentTask // "1.1"' "$STATE_FILE" 2>/dev/null)
INFRA_STATUS=$(jq -r '.connectivity // "Unknown"' "$INFRA_FILE" 2>/dev/null)
USER_PROMPT=$(echo "$input" | jq -r '.prompt // ""')

TASK_FILE="$PLAN_DIR/step-${STEP}/task-${TASK}.md"
PLAN_CONTENT=$(cat "$TASK_FILE" 2>/dev/null || echo "âš ï¸ í˜„ì¬ íƒœìŠ¤í¬ ê³„íšì„œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. /planì„ ë¨¼ì € ì‹¤í–‰í•˜ì„¸ìš”.")

# [NEW] CRCT Context Load
ACTIVE_CTX=$(cat "cline_docs/activeContext.md" 2>/dev/null | head -n 10 || echo "No active context.")

# [3] ì»¨í…ìŠ¤íŠ¸ êµ¬ì„± (Minerva v3.1 Optimized)
CONTEXT="â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ›ï¸ MINERVA v3.1: HYBRID CONTEXT ACTIVE (SES + CRCT)
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ¯ [PROGRESS] Step $STEP > Task $TASK
ğŸŒ [INFRA] $INFRA_STATUS
ğŸ§  [MEMO] $ACTIVE_CTX

âš ï¸ ACTIVE CONSTRAINTS:
1. ğŸ” SES First: Use jetbrains-mcp to scan symbols before coding.
2. ğŸ§¹ Tidy First: Clean structure before behavior change.
3. ğŸ“ CRCT Sync: Update cline_docs/ after this task.
4. ğŸ”´ Standard: 2026 Latest Versions only.

[CURRENT TASK DETAIL]
$PLAN_CONTENT
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ“ USER INPUT:
$USER_PROMPT"

# [4] ìµœì¢… ì¶œë ¥
jq -n --arg ctx "$CONTEXT" '{
  "cancel": false,
  "contextModification": $ctx
}'
exit 0